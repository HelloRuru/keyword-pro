<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>關鍵字螢光筆 Pro - SEO 寫手分頁旗艦版</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --bg-paper: #FBFBF9;
      --bg-cream: #F3F2EE;
      --text-sumi: #2C2C2C;
      --color-indigo: #374B6D;
      --color-red-accent: #B93A32;
      --border-line: #E0E0DE;
      --txt-sumi: #2C2C2C; --txt-red: #B93A32; --txt-indigo: #374B6D; --txt-green: #3F6C45; --txt-purple: #5A4498;
      --hi-sakura: #FEF4F4; --hi-nanohana: #FFF799; --hi-wakae: #E0EBDF; --hi-mizu: #BCE2E8; --hi-fuji: #E6E6FA;
    }

    /* 響應式佈局：手機版隱藏背景捲動 */
    html, body { 
      height: 100%; 
      overflow: hidden; 
      font-family: 'Noto Sans JP', sans-serif; 
      background-color: var(--bg-paper); 
      color: var(--text-sumi); 
    }

    .serif-font { font-family: 'Noto Serif JP', serif; }
    .app-container { display: flex; flex-direction: column; height: 100vh; }

    /* 任務：分頁標籤系統 */
    .tab-nav { display: flex; border-bottom: 1px solid var(--border-line); background: var(--bg-paper); }
    .tab-btn { flex: 1; padding: 12px; font-size: 13px; font-weight: 700; text-align: center; border-bottom: 2px solid transparent; transition: 0.3s; }
    .tab-btn.active { color: var(--color-indigo); border-bottom-color: var(--color-indigo); background: #f8fafc; }

    .main-workspace { display: flex; flex: 1; overflow: hidden; position: relative; }

    /* 響應式側邊欄與預覽區 */
    .sidebar-input { 
      width: 100%; 
      height: 100%;
      background: var(--bg-paper); 
      display: flex; 
      flex-direction: column; 
      position: absolute;
      left: 0; top: 0;
      transition: transform 0.3s ease-in-out;
      z-index: 20;
    }
    .preview-section { 
      width: 100%;
      height: 100%;
      background-color: var(--bg-cream); 
      display: flex; 
      flex-direction: column; 
      position: absolute;
      left: 0; top: 0;
      transition: transform 0.3s ease-in-out;
    }

    /* 電腦版恢復橫向並排 */
    @media (min-width: 768px) {
      .sidebar-input { position: static; width: 380px; border-right: 1px solid var(--border-line); transform: none !important; }
      .preview-section { position: static; flex: 1; transform: none !important; }
      .tab-nav { display: none; }
    }

    .scroll-block { flex: 1; overflow-y: auto; padding: 24px; border-bottom: 1px solid var(--border-line); }
    .scroll-block:last-child { border-bottom: none; }
    
    /* 工具列支援橫滑 */
    .inline-toolbar { 
      background: var(--bg-paper); 
      border-bottom: 1px solid var(--border-line); 
      padding: 8px 16px; 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      shrink-0; 
      overflow-x: auto; 
    }
    .inline-toolbar::-webkit-scrollbar { display: none; }

    /* 編輯器核心 */
    .scrollable-preview-area { flex: 1; overflow-y: auto; padding: 20px md:padding: 40px; display: flex; flex-direction: column; align-items: center; }
    .editor-paper { 
      width: 100%; max-width: 800px; min-height: 1100px; 
      background: var(--bg-paper); padding: 40px md:padding: 60px; 
      border: 1px solid var(--border-line); box-shadow: 0 4px 30px rgba(0,0,0,0.02); 
      outline: none; line-height: 2.2; font-size: 16px md:font-size: 17px; 
    }

    /* SEO 密度預警 */
    .density-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    .density-good { background: #E2ECE1; color: #3F6C45; }
    .density-warn { background: #FFF9D1; color: #B08F26; }
    .density-over { background: #FFF0F0; color: #B93A32; }

    .swatch-item { width: 22px; height: 22px; border-radius: 50%; border: 1px solid #eee; cursor: pointer; position: relative; flex-shrink: 0; }
    .swatch-item::after { 
      content: attr(data-name); position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%); 
      background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; 
      white-space: nowrap; opacity: 0; pointer-events: none; transition: 0.2s; 
    }
    .swatch-item:hover::after { opacity: 1; }

    .status-bar { width: 100%; background: var(--bg-paper); border-top: 1px solid var(--border-line); padding: 10px 24px; font-size: 10px; color: #94a3b8; display: flex; gap: 20px; font-weight: 700; }
  </style>
</head>
<body class="app-container">

  <header class="border-b border-[var(--border-line)] px-6 py-4 flex justify-between items-center bg-[var(--bg-paper)] shrink-0">
    <div class="flex items-center gap-3">
      <i data-lucide="highlighter" class="w-6 h-6 text-[var(--color-indigo)]"></i>
      <div>
        <h1 class="text-lg font-black text-[var(--color-indigo)] tracking-widest serif-font">蛍光ペン Pro</h1>
        <span class="text-[9px] text-slate-500 serif-font block mt-1">| 文案寫手の數位工具</span>
      </div>
    </div>
    <button onclick="copyToDocs()" class="border border-[var(--text-sumi)] px-5 py-1.5 rounded-full text-[10px] font-bold hover:bg-[var(--text-sumi)] hover:text-white transition-all">複製到 Docs</button>
  </header>

  <nav class="tab-nav md:hidden">
    <button id="tabInput" onclick="switchTab('input')" class="tab-btn active serif-font">內容與字庫</button>
    <button id="tabPreview" onclick="switchTab('preview')" class="tab-btn serif-font">即時預覽</button>
  </nav>

  <main class="main-workspace">
    <div id="sidePane" class="sidebar-input">
      <div class="scroll-block h-1/2">
        <div class="flex items-center justify-between font-black text-[11px] text-[var(--color-indigo)] mb-3 serif-font uppercase">
          <span><i data-lucide="file-text" class="w-3 h-3 inline mr-1"></i>01. 來源內容</span>
        </div>
        <textarea id="sourceText" oninput="syncPreview()" class="w-full h-full bg-transparent outline-none resize-none text-sm leading-relaxed serif-font" placeholder="貼上文案..."></textarea>
      </div>

      <div class="scroll-block h-1/2">
        <div class="flex items-center justify-between font-black text-[11px] text-[var(--color-indigo)] mb-3 serif-font uppercase">
          <span><i data-lucide="database" class="w-3 h-3 inline mr-1"></i>02. SEO 字庫</span>
          <div class="flex gap-2">
            <button onclick="saveKeywordSet()" class="text-[9px] border px-1.5 py-0.5 rounded">儲存</button>
            <select id="keywordBankSelect" onchange="loadKeywordSet()" class="text-[9px] border rounded bg-white max-w-[80px]">
              <option value="">載入</option>
            </select>
          </div>
        </div>
        <textarea id="kwList" oninput="runDensityAnalysis()" class="w-full h-32 bg-transparent border-b border-[var(--border-line)] outline-none resize-none text-sm mb-3" placeholder="每行一個關鍵字..."></textarea>
        <div id="densityResults" class="space-y-1 overflow-y-auto max-h-32 mb-4"></div>
        <button onclick="runAutoMark()" class="w-full border border-[var(--color-red-accent)] text-[var(--color-red-accent)] py-2.5 rounded text-xs font-black hover:bg-[var(--color-red-accent)] hover:text-white transition-all serif-font shadow-sm">一鍵 SEO 標註</button>
      </div>
    </div>

    <div id="previewPane" class="preview-section translate-x-full md:translate-x-0">
      <div class="inline-toolbar">
        <div class="flex gap-1 shrink-0">
          <button onclick="cmd('undo')" class="p-1.5 hover:bg-slate-100 rounded"><i data-lucide="undo-2" class="w-4 h-4"></i></button>
          <button onclick="cmd('redo')" class="p-1.5 hover:bg-slate-100 rounded"><i data-lucide="redo-2" class="w-4 h-4"></i></button>
        </div>
        <div class="w-px h-4 bg-slate-200 shrink-0"></div>
        <button id="redBoldBtn" onclick="applyRedBold()" class="btn-red-bold serif-font shrink-0" title="紅字粗體 (Ctrl+Shift+R)">
          <i data-lucide="type" class="w-3 h-3"></i> A+紅粗
        </button>
        <div class="w-px h-4 bg-slate-200 shrink-0"></div>
        <div class="flex gap-1.5 shrink-0 items-center">
          <div class="swatch-item" style="background-color: var(--txt-sumi);" data-name="墨" onclick="cmd('foreColor', 'var(--txt-sumi)')"></div>
          <div class="swatch-item" style="background-color: var(--txt-red);" data-name="朱赤" onclick="cmd('foreColor', 'var(--txt-red)')"></div>
          <div class="swatch-item" style="background-color: var(--txt-indigo);" data-name="靛藍" onclick="cmd('foreColor', 'var(--txt-indigo)')"></div>
        </div>
        <div class="w-px h-4 bg-slate-200 shrink-0"></div>
        <div class="flex gap-1.5 shrink-0 items-center">
          <div class="swatch-item" style="background-color: var(--hi-sakura);" data-name="櫻色" onclick="applyHighlight('var(--hi-sakura)')"></div>
          <div class="swatch-item" style="background-color: var(--hi-nanohana);" data-name="菜色" onclick="applyHighlight('var(--hi-nanohana)')"></div>
          <div class="swatch-item" style="background-color: var(--hi-mizu);" data-name="水色" onclick="applyHighlight('var(--hi-mizu)')"></div>
          <button onclick="applyHighlight('transparent')" class="p-1 hover:bg-slate-100 rounded"><i data-lucide="ban" class="w-3 h-3 text-slate-300"></i></button>
        </div>
      </div>

      <div class="scrollable-preview-area">
        <div id="editor" contenteditable="true" class="editor-paper serif-font" placeholder="內容將即時顯示於此..."></div>
      </div>

      <footer class="status-bar serif-font">
        <span>TOTAL: <span id="totalCount" class="text-slate-600">0</span></span>
        <span>SELECT: <span id="selectCount" class="text-slate-600">0</span></span>
        <span class="hidden md:inline">| Made by Ruru Tsai | © 2025</span>
      </footer>
    </div>
  </main>

  <script>
    lucide.createIcons();
    const editor = document.getElementById('editor');
    const source = document.getElementById('sourceText');
    const totalCount = document.getElementById('totalCount');
    const selectCount = document.getElementById('selectCount');
    const kwListArea = document.getElementById('kwList');
    const densityResults = document.getElementById('densityResults');

    // 任務：分頁切換邏輯
    function switchTab(tab) {
      const side = document.getElementById('sidePane');
      const prev = document.getElementById('previewPane');
      const btnIn = document.getElementById('tabInput');
      const btnPre = document.getElementById('tabPreview');
      
      if(tab === 'input') {
        side.style.transform = "translateX(0)";
        prev.style.transform = "translateX(100%)";
        btnIn.classList.add('active');
        btnPre.classList.remove('active');
      } else {
        side.style.transform = "translateX(-100%)";
        prev.style.transform = "translateX(0)";
        btnPre.classList.add('active');
        btnIn.classList.remove('active');
      }
    }

    // 任務：SEO 密度監控深刻思考
    function runDensityAnalysis() {
      const keywords = kwListArea.value.split('\n').filter(k => k.trim() !== "");
      const content = editor.innerText || "";
      const totalChars = content.replace(/\s/g, '').length;
      densityResults.innerHTML = "";
      if (totalChars === 0) return;

      keywords.forEach(kw => {
        const regex = new RegExp(kw.trim(), 'gi');
        const count = (content.match(regex) || []).length;
        // SEO 密度：關鍵字佔全文比例
        const density = ((count * kw.trim().length / totalChars) * 100).toFixed(1);
        
        let statusClass = "density-good";
        let msg = "理想";
        if (density > 3.0) { statusClass = "density-over"; msg = "過度"; }
        else if (density > 2.5) { statusClass = "density-warn"; msg = "偏高"; }
        else if (count === 0) { statusClass = "density-over"; msg = "未偵測"; }

        const div = document.createElement('div');
        div.className = "flex justify-between items-center text-[10px] border-b border-gray-50 pb-0.5";
        div.innerHTML = `<span class="serif-font text-gray-500">${kw}</span><span class="density-tag ${statusClass}">${density}% ${msg}</span>`;
        densityResults.appendChild(div);
      });
    }

    // 初始化與快捷鍵
    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'R') { e.preventDefault(); applyRedBold(); }
    });

    function syncPreview() { editor.innerText = source.value; updateCounts(); runDensityAnalysis(); }
    function updateCounts() { totalCount.innerText = (editor.innerText || "").replace(/\s/g, '').length; }
    document.addEventListener('selectionchange', () => { selectCount.innerText = window.getSelection().toString().replace(/\s/g, '').length; });

    // 字庫功能
    function saveKeywordSet() {
      const name = prompt("字庫名稱：");
      if (!name) return;
      let bank = JSON.parse(localStorage.getItem('kwBank') || "{}");
      bank[name] = kwListArea.value;
      localStorage.setItem('kwBank', JSON.stringify(bank));
      refreshBankUI();
    }

    function refreshBankUI() {
      const select = document.getElementById('keywordBankSelect');
      const bank = JSON.parse(localStorage.getItem('kwBank') || "{}");
      select.innerHTML = '<option value="">載入</option>';
      Object.keys(bank).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name; select.appendChild(opt);
      });
    }

    function loadKeywordSet() {
      const select = document.getElementById('keywordBankSelect');
      const bank = JSON.parse(localStorage.getItem('kwBank') || "{}");
      if (select.value && bank[select.value]) { kwListArea.value = bank[select.value]; runDensityAnalysis(); }
    }

    function cmd(c, v = null) {
      if (v && v.startsWith('var')) v = getComputedStyle(document.documentElement).getPropertyValue(v.slice(4, -1));
      document.execCommand(c, false, v);
      editor.focus();
    }
    
    function applyRedBold() { cmd('bold'); cmd('foreColor', '#B93A32'); }
    function applyHighlight(color) {
      const actualColor = color.startsWith('var') ? getComputedStyle(document.documentElement).getPropertyValue(color.slice(4, -1)) : color;
      document.execCommand('hiliteColor', false, actualColor);
      editor.focus();
    }

    function runAutoMark() {
      const list = kwListArea.value.split('\n').filter(t => t.trim() !== "");
      let html = editor.innerText;
      list.forEach(kw => {
        const regex = new RegExp(`(${kw.trim()})`, 'g');
        html = html.replace(regex, `<span style="color:#B93A32; font-weight:bold; border-bottom: 1px dashed #B93A32;">$1</span>`);
      });
      editor.innerHTML = html;
      updateCounts(); runDensityAnalysis();
    }

    async function copyToDocs() {
      const blob = new Blob([editor.innerHTML], { type: 'text/html' });
      const data = [new ClipboardItem({ 'text/html': blob, 'text/plain': new Blob([editor.innerText], { type: 'text/plain' }) })];
      await navigator.clipboard.write(data);
      alert('✨ 格式已複製。');
    }

    editor.addEventListener('input', () => { updateCounts(); runDensityAnalysis(); });
    refreshBankUI();
  </script>
</body>
</html>
