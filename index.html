<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>關鍵字螢光筆 Pro - SEO 寫手數位工具</title>
  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23374B6D' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m12 19 7-7 3 3-7 7-3-3Z'/%3E%3Cpath d='m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5Z'/%3E%3Cpath d='m2 2 5 2.25'/%3E%3Cpath d='m11 4 2 1.5'/%3E%3C/svg%3E">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;600;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* --- 0. Design System --- */
    :root {
      --bg-paper: #F9F8F4;      
      --bg-backdrop: #EBEAE4;   
      --text-primary: #2C2C2C;  
      --color-indigo: #374B6D;  
      --color-red: #B93A32;     
      --border-line: #E0E0DE;
    }

    /* --- 1. Global Layout Fix (Crucial) --- */
    html, body { 
      height: 100%; width: 100%; overflow: hidden; 
      font-family: 'Noto Sans JP', sans-serif; 
      background-color: var(--bg-paper); 
      color: var(--text-primary); 
      margin: 0; padding: 0;
    }
    .serif-font { font-family: 'Noto Serif JP', serif; }
    
    .app-container { 
      display: flex; flex-direction: column; height: 100vh; width: 100vw;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--color-indigo); }

    /* --- 2. Components --- */
    
    /* Header (Fixed) */
    .header-area { 
      flex-shrink: 0; height: 70px; z-index: 50; background: var(--bg-paper); 
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid var(--border-line);
      padding: 0 24px;
    }

    /* Main Workspace (Split View) */
    .main-workspace { 
      display: flex; flex: 1; overflow: hidden; position: relative; 
      height: calc(100vh - 70px); /* Explicit height calculation */
    }

    /* Sidebar (Left) */
    .sidebar-input { 
      width: 380px; height: 100%; background: #fff; border-right: 1px solid var(--border-line);
      display: flex; flex-direction: column; flex-shrink: 0; z-index: 20;
    }
    
    /* Responsive Sidebar */
    @media (max-width: 768px) { .sidebar-input { display: none; } }

    .scroll-block { 
      padding: 24px; border-bottom: 1px solid var(--border-line); 
    }
    .scroll-block.flex-grow { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    
    textarea { 
      width: 100%; resize: none; background: transparent; outline: none; border: none; 
      font-size: 14px; line-height: 1.8; color: #4b5563; flex: 1;
    }

    /* --- 3. Preview Section (The Logic Core) --- */
    .preview-section { 
      flex: 1; 
      background-color: var(--bg-backdrop); 
      background-image: radial-gradient(#d1d1d1 1px, transparent 1px);
      background-size: 20px 20px;
      display: flex; flex-direction: column; overflow: hidden; position: relative;
    }

    /* Toolbar (Fixed Top of Preview) */
    .inline-toolbar { 
      background: #fff; border-bottom: 1px solid rgba(0,0,0,0.06); 
      height: 50px; flex-shrink: 0;
      padding: 0 24px; display: flex; align-items: center; gap: 12px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.02); z-index: 40;
    }

    /* Scrollable Area (The Infinite Scroll Fix) */
    .scrollable-preview-area { 
      flex: 1; 
      overflow-y: auto; 
      overflow-x: hidden;
      display: flex; 
      flex-direction: column; /* Stack vertically */
      align-items: center;    /* Center horizontally */
      padding-top: 40px;
      padding-bottom: 150px;  /* Huge padding to prevent bottom cutoff */
    }

    /* The Paper (The Infinite Height Fix) */
    .editor-paper { 
      width: 100%; max-width: 800px; 
      min-height: 1200px;          /* Starts tall */
      height: auto;                /* Allows infinite growth */
      background: #FFFFFF; 
      padding: 80px 70px;          /* Luxury spacing */
      
      /* Typography & Break Rules */
      white-space: pre-wrap;       /* Respect line breaks */
      word-wrap: break-word;       /* Break long words */
      overflow-wrap: break-word;   /* Standard break */
      line-height: 2.2;            
      font-size: 17px; 
      color: #333;
      
      /* Visuals */
      box-shadow: 0 4px 25px rgba(0,0,0,0.05), 0 1px 5px rgba(0,0,0,0.02);
      border-radius: 2px;
    }

    /* Mobile Adapt */
    @media (max-width: 768px) {
      .editor-paper { padding: 40px 25px; min-height: 800px; width: 95%; }
      .scrollable-preview-area { padding-bottom: 100px; }
    }

    /* --- 4. UI Elements --- */
    .icon-btn { padding: 6px; border-radius: 6px; color: #64748b; transition: 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .icon-btn:hover { background: #f1f5f9; color: var(--color-indigo); }
    
    .swatch-item { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #e2e8f0; cursor: pointer; transition: transform 0.2s; }
    .swatch-item:hover { transform: scale(1.15); z-index: 10; }

    .btn-primary { 
      width: 100%; padding: 10px; border-radius: 8px; 
      background: var(--color-red); color: white; font-weight: 700;
      display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px;
      box-shadow: 0 2px 5px rgba(185, 58, 50, 0.2); transition: 0.2s;
    }
    .btn-primary:hover { background: #a32f27; }
    
    .status-bar { 
      height: 40px; background: #fff; border-top: 1px solid var(--border-line); 
      padding: 0 24px; font-size: 11px; color: #94a3b8; font-weight: 700; 
      display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
      position: absolute; bottom: 0; right: 0; left: 0; /* Float over preview */
      z-index: 60;
    }
    
    .divider { width: 1px; height: 20px; background: #e2e8f0; margin: 0 8px; }
    .label-text { font-size: 11px; font-weight: 700; color: var(--color-indigo); text-transform: uppercase; letter-spacing: 0.1em; display: flex; align-items: center; margin-bottom: 8px; }
  </style>
</head>
<body class="app-container">

  <header class="header-area">
    <div class="flex items-center gap-4">
      <div class="w-9 h-9 border-2 border-[var(--color-indigo)] flex items-center justify-center rounded text-[var(--color-indigo)]">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 19 7-7 3 3-7 7-3-3Z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5Z"/></svg>
      </div>
      <div>
        <h1 class="text-lg font-black text-[var(--color-indigo)] tracking-[0.2em] serif-font">蛍光ペン PRO</h1>
      </div>
    </div>
    <button onclick="copyToDocs()" class="px-5 py-2 border border-[var(--text-primary)] rounded-full text-xs font-bold hover:bg-[var(--text-primary)] hover:text-white transition-all tracking-widest">複製文案</button>
  </header>

  <main class="main-workspace">
    <div class="sidebar-input">
      <div class="scroll-block flex-grow" style="flex: 2;">
        <div class="label-text">
          <svg class="w-3.5 h-3.5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
          原文輸入 (Source)
        </div>
        <textarea id="sourceText" oninput="syncPreview()" placeholder="請在此貼上文章草稿，右側將即時預覽..."></textarea>
      </div>
      
      <div class="scroll-block bg-slate-50" style="flex: 1; display: flex; flex-direction: column;">
        <div class="label-text">
          <svg class="w-3.5 h-3.5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
          SEO 關鍵字庫
        </div>
        <textarea id="kwList" oninput="runDensityAnalysis()" class="h-16 mb-2 !text-sm border-b border-dashed border-slate-300 bg-transparent shrink-0" placeholder="每行一個關鍵字..."></textarea>
        
        <div id="densityResults" class="flex-1 overflow-y-auto mb-3 pr-1 space-y-1 min-h-0"></div>
        
        <button onclick="runAutoMark()" class="btn-primary mb-2 shrink-0">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
          一鍵標註 (Auto Mark)
        </button>
        <button onclick="resetAll()" class="text-[10px] text-slate-400 hover:text-red-500 underline text-center w-full block shrink-0">清除所有內容</button>
      </div>
    </div>

    <div class="preview-section">
      <div class="inline-toolbar">
        <button onmousedown="event.preventDefault(); cmd('undo')" class="icon-btn" title="復原"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg></button>
        <button onmousedown="event.preventDefault(); cmd('redo')" class="icon-btn" title="重做"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/></svg></button>
        
        <div class="divider"></div>
        
        <div class="flex items-center gap-2" title="文字顏色">
           <div class="swatch-item bg-[#2C2C2C]" onmousedown="event.preventDefault(); applyColor('#2C2C2C')"></div>
           <div class="swatch-item bg-[#B93A32]" onmousedown="event.preventDefault(); applyColor('#B93A32')"></div>
           <div class="swatch-item bg-[#374B6D]" onmousedown="event.preventDefault(); applyColor('#374B6D')"></div>
        </div>

        <div class="divider"></div>

        <div class="flex items-center gap-2" title="螢光筆背景">
          <div class="swatch-item bg-[#FEECEC]" onmousedown="event.preventDefault(); applyHilite('#FEECEC')"></div>
          <div class="swatch-item bg-[#FFF9C4]" onmousedown="event.preventDefault(); applyHilite('#FFF9C4')"></div>
          <div class="swatch-item bg-[#D1EAED]" onmousedown="event.preventDefault(); applyHilite('#D1EAED')"></div>
          <button onmousedown="event.preventDefault(); applyHilite('transparent')" class="icon-btn ml-1" title="清除背景"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></button>
        </div>
        
        <div class="divider"></div>
        <button onmousedown="event.preventDefault(); applyRedBold()" class="border border-red-200 text-red-600 text-xs font-bold px-3 py-1 rounded-full hover:bg-red-50 transition-colors">A+ 重點</button>
      </div>

      <div class="scrollable-preview-area">
        <div id="editor" contenteditable="true" class="editor-paper serif-font" placeholder="紙張に筆を走らせるように..."></div>
      </div>
      
      <footer class="status-bar">
        <div class="flex gap-6">
          <span>字數: <span id="totalCount" class="text-slate-900">0</span></span>
          <span>選取: <span id="selectCount" class="text-slate-900">0</span></span>
        </div>
        <div class="opacity-40 font-normal">Wabi-Sabi Editor v3.0</div>
      </footer>
    </div>
  </main>

  <script>
    // --- Logic Core ---
    const editor = document.getElementById('editor'); 
    const source = document.getElementById('sourceText');
    const totalCount = document.getElementById('totalCount'); 
    const selectCount = document.getElementById('selectCount');
    const kwListArea = document.getElementById('kwList'); 
    const densityResults = document.getElementById('densityResults');

    function cmd(command, value = null) {
      editor.focus();
      document.execCommand(command, false, value);
      updateCounts(); 
    }

    // Fix: Explicit Hex Codes for Colors
    function applyColor(hex) { cmd('foreColor', hex); }
    
    // Fix: Highlight Compatibility
    function applyHilite(hex) {
      if (!document.execCommand('hiliteColor', false, hex)) {
        document.execCommand('backColor', false, hex); 
      }
      editor.focus();
    }

    function applyRedBold() {
      editor.focus();
      document.execCommand('bold');
      applyColor('#B93A32');
    }

    function syncPreview() {
      const raw = source.value;
      editor.innerText = raw; 
      updateCounts();
      runDensityAnalysis();
    }

    function updateCounts() {
      totalCount.innerText = editor.innerText.replace(/\s/g, '').length;
    }

    document.addEventListener('selectionchange', () => {
      const sel = window.getSelection().toString();
      selectCount.innerText = sel.replace(/\s/g, '').length;
    });

    function runDensityAnalysis() {
      const keywords = kwListArea.value.split('\n').filter(k => k.trim() !== "");
      const content = editor.innerText || "";
      const totalChars = content.length;
      
      densityResults.innerHTML = "";
      if (totalChars === 0 && keywords.length > 0) return;

      keywords.forEach(kw => {
        const regex = new RegExp(kw.trim(), 'gi');
        const count = (content.match(regex) || []).length;
        const density = ((count * kw.trim().length / totalChars) * 100).toFixed(1);
        
        let badgeClass = "bg-gray-100 text-gray-600";
        if (density > 0 && density <= 1) badgeClass = "bg-green-100 text-green-700";
        if (density > 1 && density <= 3) badgeClass = "bg-blue-100 text-blue-700";
        if (density > 3) badgeClass = "bg-red-100 text-red-700";

        const div = document.createElement('div');
        div.className = "flex justify-between items-center text-xs border-b border-gray-100 pb-1 pt-1";
        div.innerHTML = `
          <span class="text-slate-600 truncate mr-2 w-20" title="${kw}">${kw}</span>
          <span class="px-2 py-0.5 rounded-full ${badgeClass} font-mono font-bold">${density}%</span>
        `;
        densityResults.appendChild(div);
      });
    }

    function runAutoMark() {
      const list = kwListArea.value.split('\n').filter(t => t.trim() !== "");
      if (list.length === 0) return;

      let html = editor.innerText;
      // Basic HTML Escape for security
      html = html.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

      list.forEach(kw => {
        const cleanKw = kw.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
        const regex = new RegExp(`(${cleanKw})`, 'gi');
        html = html.replace(regex, `<span style="color:#B93A32; font-weight:bold; text-decoration: underline; text-decoration-style: dashed; text-decoration-color: #B93A32;">$1</span>`);
      });
      
      editor.innerHTML = html;
      updateCounts();
    }

    function resetAll() {
      if (confirm("確定要清空所有內容嗎？")) {
        source.value = ""; kwListArea.value = ""; editor.innerHTML = ""; densityResults.innerHTML = ""; updateCounts();
      }
    }

    async function copyToDocs() {
      const blobHtml = new Blob([editor.innerHTML], { type: 'text/html' });
      const blobText = new Blob([editor.innerText], { type: 'text/plain' });
      const data = [new ClipboardItem({ 'text/html': blobHtml, 'text/plain': blobText })];
      
      try {
        await navigator.clipboard.write(data);
        const btn = document.querySelector('header button');
        const originalText = btn.innerText;
        btn.innerText = "✨ 已複製！";
        setTimeout(() => btn.innerText = originalText, 2000);
      } catch (err) {
        alert('複製失敗。');
      }
    }

    source.value = ""; editor.focus();
  </script>
</body>
</html>
