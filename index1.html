<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>關鍵字螢光筆 Pro - SEO 寫手專用版</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --bg-paper: #FBFBF9;
      --bg-cream: #F3F2EE;
      --text-sumi: #2C2C2C;
      --color-indigo: #374B6D;
      --color-red-accent: #B93A32; /* 朱赤 */
      --border-line: #E0E0DE;
      /* 日本傳統色 (和色) */
      --txt-sumi: #2C2C2C; --txt-red: #B93A32; --txt-indigo: #374B6D; --txt-green: #3F6C45; --txt-purple: #5A4498;
      --hi-sakura: #FEF4F4; --hi-nanohana: #FFF799; --hi-wakae: #E0EBDF; --hi-mizu: #BCE2E8; --hi-fuji: #E6E6FA;
    }

    html, body { height: 100%; overflow: hidden; font-family: 'Noto Sans JP', sans-serif; background-color: var(--bg-paper); color: var(--text-sumi); letter-spacing: 0.04em; }
    .serif-font { font-family: 'Noto Serif JP', serif; }
    .app-container { display: flex; flex-direction: column; height: 100vh; }
    .main-workspace { display: flex; flex: 1; overflow: hidden; }

    /* 左側輸入區區隔設計 */
    .sidebar-input { width: 380px; border-right: 1px solid var(--border-line); background: var(--bg-paper); display: flex; flex-direction: column; z-index: 20; }
    .scroll-block { flex: 1; overflow-y: auto; padding: 24px; border-bottom: 1px solid var(--border-line); }
    .block-header { display: flex; align-items: center; justify-content: space-between; font-size: 14px; font-weight: 900; color: var(--color-indigo); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.1em; }

    /* 密度監控面板 */
    .density-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    .density-good { background: #E2ECE1; color: #3F6C45; } /* 1-2.5% */
    .density-warn { background: #FFF9D1; color: #B08F26; } /* 2.5-3% */
    .density-over { background: #FFF0F0; color: #B93A32; } /* >3% (Keyword Stuffing) */

    /* 右側預覽區 (全凍結與內部滾動) */
    .preview-section { flex: 1; background-color: var(--bg-cream); display: flex; flex-direction: column; position: relative; }
    .inline-toolbar { background: var(--bg-paper); border-bottom: 1px solid var(--border-line); padding: 8px 24px; display: flex; align-items: center; gap: 12px; shrink-0; }
    .scrollable-preview-area { flex: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; align-items: center; }
    .editor-paper { width: 100%; max-width: 800px; min-height: 1100px; background: var(--bg-paper); padding: 60px; border: 1px solid var(--border-line); box-shadow: 0 4px 30px rgba(0,0,0,0.03); outline: none; line-height: 2.2; font-size: 17px; margin-bottom: 40px; position: relative; }

    /* 線條感按鈕 */
    .btn-red-bold { color: var(--color-red-accent); border: 1.5px solid var(--color-red-accent); padding: 4px 14px; border-radius: 4px; font-weight: 900; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 13px; }
    .btn-red-bold:hover { background: #FFF5F5; transform: translateY(-1px); }
    
    .status-bar { width: 100%; background: var(--bg-paper); border-top: 1px solid var(--border-line); padding: 10px 40px; font-size: 11px; color: #94a3b8; display: flex; gap: 24px; font-weight: 700; }

    /* 色票樣式與自定義名稱 */
    .swatch-item { width: 22px; height: 22px; border-radius: 50%; border: 1px solid #eee; cursor: pointer; transition: 0.2s; position: relative; }
    .swatch-item:hover { transform: scale(1.25); }
    .swatch-item::after { content: attr(data-name); position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%); background: var(--text-sumi); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; white-space: nowrap; opacity: 0; pointer-events: none; transition: 0.2s; }
    .swatch-item:hover::after { opacity: 1; }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: #E0E0DE; border-radius: 10px; }
  </style>
</head>
<body class="app-container">

  <header class="border-b border-[var(--border-line)] px-8 py-5 flex justify-between items-center bg-[var(--bg-paper)] shrink-0">
    <div class="flex items-center gap-4">
      <i data-lucide="highlighter" class="w-6 h-6 text-[var(--color-indigo)]"></i>
      <div>
        <h1 class="text-xl font-black text-[var(--color-indigo)] tracking-widest serif-font leading-none">蛍光ペン Pro</h1>
        <span class="text-[10px] text-slate-500 serif-font block mt-1 tracking-tight">| 文案寫手の數位工具</span>
      </div>
    </div>
    <div class="flex items-center gap-8">
      <div class="text-[10px] text-slate-300 serif-font text-right leading-tight">Made by Ruru Tsai<br>© 2025 Ruru Tsai 版權所有</div>
      <button onclick="copyToDocs()" class="border border-[var(--text-sumi)] px-8 py-2 rounded-full text-xs font-bold hover:bg-[var(--text-sumi)] hover:text-white transition-all serif-font">複製到 Google Docs</button>
    </div>
  </header>

  <main class="main-workspace">
    <div class="sidebar-input">
      <div class="scroll-block h-1/2">
        <div class="block-header serif-font">
          <span><i data-lucide="file-text" class="w-4 h-4 inline mr-2"></i>來源內容</span>
        </div>
        <textarea id="sourceText" oninput="syncPreview()" class="w-full h-[calc(100%-24px)] bg-transparent outline-none resize-none text-sm leading-relaxed serif-font" placeholder="從 Word 或 Docs 直接貼上內容..."></textarea>
      </div>

      <div class="scroll-block h-1/2">
        <div class="block-header serif-font">
          <span><i data-lucide="database" class="w-4 h-4 inline mr-2"></i>常用字庫</span>
          <div class="flex gap-2">
            <button onclick="saveKeywordSet()" class="text-[10px] border px-2 py-0.5 rounded">儲存目前</button>
            <button onclick="clearKeywordSets()" class="text-[10px] border px-2 py-0.5 rounded text-red-400">清空</button>
          </div>
        </div>
        <select id="keywordBankSelect" onchange="loadKeywordSet()" class="w-full text-xs mb-3 p-1 border rounded bg-white outline-none">
          <option value="">-- 選擇已存字庫 --</option>
        </select>
        
        <textarea id="kwList" oninput="runDensityAnalysis()" class="w-full h-32 bg-transparent border-b border-[var(--border-line)] outline-none resize-none text-sm mb-3 font-mono" placeholder="每行輸入一個關鍵字..."></textarea>
        
        <div id="densityResults" class="space-y-2 overflow-y-auto max-h-40">
          </div>

        <button onclick="runAutoMark()" class="w-full mt-4 border border-[var(--color-red-accent)] text-[var(--color-red-accent)] py-3 rounded-lg text-sm font-black hover:bg-[var(--color-red-accent)] hover:text-white transition-all serif-font shadow-sm">
          執行 SEO 標註
        </button>
      </div>
    </div>

    <div class="preview-section">
      <div class="inline-toolbar">
        <button onclick="cmd('undo')" class="p-2 hover:bg-slate-100 rounded" title="復原 (Ctrl+Z)"><i data-lucide="undo-2" class="w-4 h-4"></i></button>
        <button onclick="cmd('redo')" class="p-2 hover:bg-slate-100 rounded" title="重做 (Ctrl+Y)"><i data-lucide="redo-2" class="w-4 h-4"></i></button>
        <div class="w-px h-5 bg-slate-200 mx-1"></div>

        <button id="redBoldBtn" onclick="applyRedBold()" class="btn-red-bold serif-font" title="紅字粗體 (Ctrl+Shift+R)">
          <i data-lucide="type" class="w-4 h-4"></i> BA+紅粗
        </button>

        <div class="w-px h-5 bg-slate-200 mx-1"></div>

        <div class="flex items-center gap-3">
          <i data-lucide="baseline" class="w-4 h-4 text-slate-400"></i>
          <div class="flex gap-1.5">
            <div class="swatch-item" style="background-color: var(--txt-sumi);" data-name="墨 (Sumi)" onclick="cmd('foreColor', 'var(--txt-sumi)')"></div>
            <div class="swatch-item" style="background-color: var(--txt-red);" data-name="朱赤 (Shu-aka)" onclick="cmd('foreColor', 'var(--txt-red)')"></div>
            <div class="swatch-item" style="background-color: var(--txt-indigo);" data-name="靛藍 (Indo)" onclick="cmd('foreColor', 'var(--txt-indigo)')"></div>
            <div class="swatch-item" style="background-color: var(--txt-green);" data-name="墨綠 (Mokuri)" onclick="cmd('foreColor', 'var(--txt-green)')"></div>
          </div>
        </div>

        <div class="w-px h-5 bg-slate-200 mx-1"></div>

        <div class="flex items-center gap-3">
          <i data-lucide="palette" class="w-4 h-4 text-slate-400"></i>
          <div class="flex gap-1.5">
            <div class="swatch-item" style="background-color: var(--hi-sakura);" data-name="櫻色 (Sakura)" onclick="applyHighlight('var(--hi-sakura)')"></div>
            <div class="swatch-item" style="background-color: var(--hi-nanohana);" data-name="菜色 (Nanohana)" onclick="applyHighlight('var(--hi-nanohana)')"></div>
            <div class="swatch-item" style="background-color: var(--hi-wakae);" data-name="若苗色 (Wakae)" onclick="applyHighlight('var(--hi-wakae)')"></div>
            <div class="swatch-item" style="background-color: var(--hi-mizu);" data-name="水色 (Mizu)" onclick="applyHighlight('var(--hi-mizu)')"></div>
            <div class="swatch-item" style="background-color: var(--hi-fuji);" data-name="藤色 (Fuji)" onclick="applyHighlight('var(--hi-fuji)')"></div>
            <button onclick="applyHighlight('transparent')" class="p-1 hover:bg-slate-100 rounded" title="清除背景色"><i data-lucide="ban" class="w-3 h-3 text-slate-300"></i></button>
          </div>
        </div>
      </div>

      <div class="scrollable-preview-area">
        <div id="editor" contenteditable="true" class="editor-paper serif-font" placeholder="內容將即時顯示於此..."></div>
      </div>

      <footer class="status-bar serif-font">
        <span>TOTAL: <span id="totalCount" class="text-slate-600">0</span></span>
        <span class="opacity-30">|</span>
        <span>SELECTED: <span id="selectCount" class="text-slate-600">0</span></span>
      </footer>
    </div>
  </main>

  <script>
    lucide.createIcons();
    const editor = document.getElementById('editor');
    const source = document.getElementById('sourceText');
    const totalCount = document.getElementById('totalCount');
    const selectCount = document.getElementById('selectCount');
    const kwListArea = document.getElementById('kwList');
    const densityResults = document.getElementById('densityResults');

    // 任務 4: 快捷鍵處理
    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'R') {
        e.preventDefault();
        applyRedBold();
      }
    });

    function syncPreview() { editor.innerText = source.value; updateCounts(); runDensityAnalysis(); }
    function updateCounts() { totalCount.innerText = (editor.innerText || "").replace(/\s/g, '').length; }
    document.addEventListener('selectionchange', () => { selectCount.innerText = window.getSelection().toString().replace(/\s/g, '').length; });

    // 任務 2: 深刻思考後的關鍵字密度監控 (SEO 規則)
    function runDensityAnalysis() {
      const keywords = kwListArea.value.split('\n').filter(k => k.trim() !== "");
      const content = editor.innerText || "";
      const totalChars = content.replace(/\s/g, '').length;
      
      densityResults.innerHTML = "";
      if (totalChars === 0) return;

      keywords.forEach(kw => {
        const regex = new RegExp(kw.trim(), 'gi');
        const count = (content.match(regex) || []).length;
        // 密度計算 (以字數為基礎，因中文無單詞之分)
        const density = ((count * kw.trim().length / totalChars) * 100).toFixed(1);
        
        let statusClass = "density-good";
        let msg = "理想";
        if (density > 3.0) { statusClass = "density-over"; msg = "過度優化"; }
        else if (density > 2.5) { statusClass = "density-warn"; msg = "偏高"; }
        else if (count === 0) { statusClass = "density-over"; msg = "未偵測到"; }

        const div = document.createElement('div');
        div.className = "flex justify-between items-center border-b border-gray-100 pb-1";
        div.innerHTML = `
          <span class="text-xs serif-font text-gray-600">${kw}</span>
          <div class="flex gap-2 items-center">
            <span class="text-[10px] text-gray-400">${count}次</span>
            <span class="density-tag ${statusClass}">${density}% ${msg}</span>
          </div>
        `;
        densityResults.appendChild(div);
      });
    }

    // 任務 1: 常用關鍵字庫 (localStorage)
    function saveKeywordSet() {
      const name = prompt("請輸入此字庫名稱（如：家具專案）：");
      if (!name) return;
      const keywords = kwListArea.value;
      let bank = JSON.parse(localStorage.getItem('kwBank') || "{}");
      bank[name] = keywords;
      localStorage.setItem('kwBank', JSON.stringify(bank));
      refreshBankUI();
    }

    function refreshBankUI() {
      const select = document.getElementById('keywordBankSelect');
      const bank = JSON.parse(localStorage.getItem('kwBank') || "{}");
      select.innerHTML = '<option value="">-- 選擇已存字庫 --</option>';
      Object.keys(bank).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
    }

    function loadKeywordSet() {
      const select = document.getElementById('keywordBankSelect');
      const bank = JSON.parse(localStorage.getItem('kwBank') || "{}");
      if (select.value && bank[select.value]) {
        kwListArea.value = bank[select.value];
        runDensityAnalysis();
      }
    }

    function clearKeywordSets() {
      if(confirm("確定要清空所有儲存的字庫嗎？")) {
        localStorage.removeItem('kwBank');
        refreshBankUI();
      }
    }

    // 基礎編輯功能
    function cmd(c, v = null) {
      if (c === 'foreColor' && v.startsWith('var')) {
        v = getComputedStyle(document.documentElement).getPropertyValue(v.slice(4, -1));
      }
      document.execCommand(c, false, v);
      editor.focus();
    }
    
    function applyRedBold() { 
      cmd('bold'); 
      cmd('foreColor', '#B93A32');
      // 視覺反饋
      const btn = document.getElementById('redBoldBtn');
      btn.style.background = "#FFF5F5";
      setTimeout(() => btn.style.background = "transparent", 200);
    }

    function applyHighlight(color) {
      const actualColor = color.startsWith('var') ? getComputedStyle(document.documentElement).getPropertyValue(color.slice(4, -1)) : color;
      document.execCommand('hiliteColor', false, actualColor);
      editor.focus();
    }

    function runAutoMark() {
      const list = kwListArea.value.split('\n').filter(t => t.trim() !== "");
      let html = editor.innerText;
      list.forEach(kw => {
        const regex = new RegExp(`(${kw.trim()})`, 'g');
        html = html.replace(regex, `<span style="color:#B93A32; font-weight:bold; border-bottom: 1px dashed #B93A32;">$1</span>`);
      });
      editor.innerHTML = html;
      updateCounts();
      runDensityAnalysis();
    }

    async function copyToDocs() {
      const blob = new Blob([editor.innerHTML], { type: 'text/html' });
      const data = [new ClipboardItem({ 'text/html': blob, 'text/plain': new Blob([editor.innerText], { type: 'text/plain' }) })];
      await navigator.clipboard.write(data);
      alert('✨ 格式已複製。');
    }

    editor.addEventListener('input', () => { updateCounts(); runDensityAnalysis(); });
    // 初始化 UI
    refreshBankUI();
  </script>
</body>
</html>
